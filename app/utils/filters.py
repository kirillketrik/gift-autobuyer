import json
import re
from typing import Optional, List, Dict

from pydantic import ValidationError

from app.core.models.gift_filter import GiftFilter
from .ai import ask_ai

_SYSTEM_PROMT = """
Ð¢Ñ‹ â€” Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¾Ð² Ð² Telegram.

ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ñ‚ÐµÐ±Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² JSON, ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¸Ð· ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð±Ð¾Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸.

Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð° ÑÑ‚Ñ€Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð¼Ð¾Ð´ÐµÐ»Ð¸:

{
  "min_supply": -1,               // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¾Ð² (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ -1)
  "max_supply": -1,               // ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¾Ð² (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ -1)
  "min_price": -1,                // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ñ†ÐµÐ½Ð° Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ° Ð² Ð·Ð²Ñ‘Ð·Ð´Ð°Ñ… (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ -1)
  "max_price": -1,                // ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ñ†ÐµÐ½Ð° Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ° Ð² Ð·Ð²Ñ‘Ð·Ð´Ð°Ñ… (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ -1)
  "priority": 0,                  // ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð° (Ñ‡ÐµÐ¼ Ð²Ñ‹ÑˆÐµ, Ñ‚ÐµÐ¼ Ñ€Ð°Ð½ÑŒÑˆÐµ Ð¾Ð½ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ). Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ 0â€“100
  "weight": 0,                   // Ð’ÐµÑ (Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ…) â€” Ð´Ð¾Ð»Ñ Ð¾Ñ‚ Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð°, Ð²Ñ‹Ð´ÐµÐ»ÑÐµÐ¼Ð°Ñ Ð½Ð° Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸ Ð¿Ð¾ ÑÑ‚Ð¾Ð¼Ñƒ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñƒ (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” 0)
  "max_buy_count": -1,           // ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº Ð¿Ð¾ Ð´Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñƒ (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” -1)
  "max_spend_money": -1,         // ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑƒÐ¼Ð¼Ð° Ð² Ð·Ð²Ñ‘Ð·Ð´Ð°Ñ…, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ñ‚Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñƒ (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ â€” -1)
  "ordering": "-price"           // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²: Ð¿Ð¾ `price` Ð¸Ð»Ð¸ `supply`, Ð¿Ð¾ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°Ð½Ð¸ÑŽ (`+price`, `+supply`) Ð¸Ð»Ð¸ ÑƒÐ±Ñ‹Ð²Ð°Ð½Ð¸ÑŽ (`-price`, `-supply`)
}

âš ï¸ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
- Ð’ÐµÑ€Ð½Ð¸ **Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²** JSON-Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð².
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¼, Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸.
- Ð•ÑÐ»Ð¸ Ð² Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑÐ²Ð½Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÑÐ²Ð½Ð¾ ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹ **Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹**, Ñ€Ð°Ð·Ð±ÐµÐ¹ Ð¸Ñ… Ð½Ð° **Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹**.
- Ð’ÑÐµ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ñ†ÐµÐ»Ñ‹Ð¼Ð¸ Ñ‡Ð¸ÑÐ»Ð°Ð¼Ð¸.
- ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ JSON-Ð¼Ð°ÑÑÐ¸Ð².
- Ð•ÑÐ»Ð¸ ÐºÐ°ÐºÐ¾Ðµ-Ð»Ð¸Ð±Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: `-1`, `0`, `true`, `"â€“price"`.

ðŸ’¡ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
1. "ÐŸÐ¾ÐºÑƒÐ¿Ð°Ð¹ Ð´ÐµÑˆÑ‘Ð²Ñ‹Ðµ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸ Ð´Ð¾ 100 Ð·Ð²Ñ‘Ð·Ð´" â†’ Ð¾Ð´Ð¸Ð½ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ñ `max_price: 100`.
2. "ÐšÑƒÐ¿Ð¸ Ñ€ÐµÐ´ÐºÐ¸Ðµ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸, Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 3 ÑˆÑ‚ÑƒÐºÐ¸, Ð½Ðµ Ð´Ð¾Ñ€Ð¾Ð¶Ðµ 500" â†’ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ñ `max_price`, `max_buy_count`.
3. "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð±ÐµÑ€Ð¸ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸ Ð¿Ð¾Ð´ÐµÑˆÐµÐ²Ð»Ðµ" â†’ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ñ `ordering: "+price"`.
4. "Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐ¹ Ð´Ð¾Ñ€Ð¾Ð³Ð¸Ðµ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸" â†’ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ñ `enabled: false` Ð¸ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸ÑÐ¼Ð¸.

Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¼Ñ‹ÑÐ» Ð¸ Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð½Ð° Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ðµ, Ñ‡Ñ‘Ñ‚ÐºÐ¸Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹.

Ð’Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ:"""


def _parse_filters(text: str) -> Optional[List[Dict]]:
    try:
        i = text.index('[')
        j = len(text) - 1

        while text[j] != ']' and j > 0:
            j -= 1

        return json.loads(text[i:j + 1])
    except ValueError:
        return None


async def parse_text_to_filters(query: str) -> Optional[List[GiftFilter]]:
    promt = _SYSTEM_PROMT + query
    response = await ask_ai(promt=promt)

    if response is None:
        return None

    filters = _parse_filters(response)

    if filters is None:
        return None

    result = []

    for f in filters:
        try:
            result.append(GiftFilter(**f))
        except ValidationError:
            continue

    return result


def parse_name_value_line(text: str) -> List[GiftFilter]:
    default_filter = {
        "min_price": -1,
        "max_price": -1,
        "min_supply": -1,
        "max_supply": -1,
        "priority": 0,
        "weight": 0,
        "max_buy_count": -1,
        "max_spend_money": -1,
        "ordering": "-price"
    }

    filters = []
    raw_filters = text.strip().split("\n\n")

    for raw in raw_filters:
        filter_data = default_filter.copy()
        lines = raw.strip().replace("\n", " ").split()

        for item in lines:
            if "=" not in item: continue
            key, value = (i.strip() for i in item.split("=", 1))

            if value.isdigit():
                filter_data[key] = int(value)
            elif re.match('^[-+](price|supply)$', value):
                filter_data[key] = value
        try:
            filter_obj = GiftFilter(**filter_data)
            filters.append(filter_obj)
        except ValidationError:
            continue
    return filters
